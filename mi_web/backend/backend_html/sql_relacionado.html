<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Datos Médica - SQL Relacionado</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #28a745;
            color: white;
            border-radius: 5px;
        }
        
        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .sql-button {
            padding: 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .sql-button.join-inner { background: #007bff; }
        .sql-button.join-left { background: #17a2b8; }
        .sql-button.join-aggregate { background: #ffc107; color: #000; }
        .sql-button.join-subquery { background: #6f42c1; }
        
        .sql-button:hover {
            opacity: 0.8;
        }
        
        .query-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        
        .query-section.active {
            display: block;
        }
        
        .sql-code {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .execute-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .execute-btn:hover {
            background: #0056b3;
        }
        
        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Base de Datos Médica</h1>
            <p>Práctica de SQL - Consultas Relacionadas</p>
        </div>

        <div class="buttons-grid">
            <button class="sql-button join-inner" onclick="showQuery('inner')">INNER JOIN</button>
            <button class="sql-button join-left" onclick="showQuery('left')">LEFT JOIN</button>
            <button class="sql-button join-aggregate" onclick="showQuery('aggregate')">Funciones Agregadas</button>
            <button class="sql-button join-subquery" onclick="showQuery('subquery')">Subconsultas</button>
        </div>

        <!-- INNER JOIN Query -->
        <div id="inner-query" class="query-section">
            <h3>INNER JOIN - Pacientes con Medicamentos</h3>
            <div class="sql-code" id="inner-sql">SELECT 
    r.rut,
    r.nombre AS paciente,
    r.medico_tratante,
    m.nombre AS medicamento,
    m.dosis,
    m.caso_sos
FROM residentes r
INNER JOIN medicamentos m ON r.rut = m.rut_residente
ORDER BY r.nombre, m.nombre;</div>
            <button class="execute-btn" onclick="executeQuery('inner')">Ejecutar INNER JOIN</button>
            <div class="result-area" id="inner-result">
                <p>Esta consulta muestra solo los pacientes que tienen medicamentos asignados.</p>
            </div>
        </div>

        <!-- LEFT JOIN Query -->
        <div id="left-query" class="query-section">
            <h3>LEFT JOIN - Todos los Pacientes</h3>
            <div class="sql-code" id="left-sql">SELECT 
    r.rut,
    r.nombre AS paciente,
    r.diagnostico,
    COUNT(m.id) AS total_medicamentos,
    GROUP_CONCAT(m.nombre, ', ') AS medicamentos
FROM residentes r
LEFT JOIN medicamentos m ON r.rut = m.rut_residente
GROUP BY r.rut, r.nombre, r.diagnostico
ORDER BY total_medicamentos DESC, r.nombre;</div>
            <button class="execute-btn" onclick="executeQuery('left')">Ejecutar LEFT JOIN</button>
            <div class="result-area" id="left-result">
                <p>Esta consulta incluye TODOS los pacientes, incluso los que no tienen medicamentos.</p>
            </div>
        </div>

        <!-- Aggregate Functions Query -->
        <div id="aggregate-query" class="query-section">
            <h3>Funciones Agregadas - Estadísticas por Médico</h3>
            <div class="sql-code" id="aggregate-sql">SELECT 
    medico_tratante,
    COUNT(*) as total_pacientes,
    ROUND(AVG(CAST(strftime('%Y','now') AS INTEGER) - CAST(strftime('%Y', fecha_nacimiento) AS INTEGER)), 1) as edad_promedio,
    MIN(fecha_ingreso) as primer_ingreso,
    MAX(fecha_ingreso) as ultimo_ingreso
FROM residentes 
GROUP BY medico_tratante
ORDER BY total_pacientes DESC;</div>
            <button class="execute-btn" onclick="executeQuery('aggregate')">Ejecutar Consulta Agregada</button>
            <div class="result-area" id="aggregate-result">
                <p>Esta consulta calcula estadísticas agrupadas por médico tratante.</p>
            </div>
        </div>

        <!-- Subquery -->
        <div id="subquery-query" class="query-section">
            <h3>Subconsultas - Pacientes con Más Medicamentos</h3>
            <div class="sql-code" id="subquery-sql">SELECT 
    r.rut,
    r.nombre,
    r.diagnostico,
    COUNT(m.id) as total_medicamentos
FROM residentes r
INNER JOIN medicamentos m ON r.rut = m.rut_residente
GROUP BY r.rut, r.nombre, r.diagnostico
HAVING COUNT(m.id) > (
    SELECT AVG(med_count) 
    FROM (
        SELECT COUNT(*) as med_count 
        FROM medicamentos 
        GROUP BY rut_residente
    )
)
ORDER BY total_medicamentos DESC;</div>
            <button class="execute-btn" onclick="executeQuery('subquery')">Ejecutar Subconsulta</button>
            <div class="result-area" id="subquery-result">
                <p>Esta consulta encuentra pacientes con más medicamentos que el promedio.</p>
            </div>
        </div>
    </div>

    <script>
        function showQuery(type) {
            document.querySelectorAll('.query-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(type + '-query').classList.add('active');
        }

        async function executeQuery(type) {
            const query = document.getElementById(type + '-sql').textContent;
            const resultDiv = document.getElementById(type + '-result');
            
            resultDiv.innerHTML = '<p>Ejecutando consulta...</p>';

            try {
                const response = await fetch('/api/execute-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                } else if (data.data) {
                    resultDiv.innerHTML = createTable(data.data) + `<p class="success">Registros encontrados: ${data.count}</p>`;
                } else {
                    resultDiv.innerHTML = '<p class="success">Operación completada exitosamente</p>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error de conexión: ${error.message}</p>`;
            }
        }

        function createTable(data) {
            if (!data || data.length === 0) {
                return '<p>No se encontraron datos</p>';
            }

            const headers = Object.keys(data[0]);
            let html = '<table><thead><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }
    </script>
</body>
</html>